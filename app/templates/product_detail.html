<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{{ url_for('home') }}">Hwang Store</a>
    <a href="{{ url_for('cart') }}" class="btn btn-outline-light ms-auto position-relative" id="cart-icon">
      üõí Gi·ªè h√†ng
      {% if session.get('cart') %}
      <span class="badge bg-danger">{{ session['cart']|length }}</span>
      {% endif %}
    </a>
  </div>
</nav>

<div class="container py-5">
  <div class="row g-4">
    <div class="col-md-6">
      <div class="border rounded mb-3 text-center p-3 bg-light">
        <img id="mainImage" src="{{ url_for('static', filename='images/' + media[0]['media_url']) }}"
             class="img-fluid" style="max-height: 400px;">
      </div>
      <div class="d-flex flex-wrap gap-2">
        {% for m in media[:10] %}
          {% if m['media_type'] == 'image' %}
            <img src="{{ url_for('static', filename='images/' + m['media_url']) }}"
                 onclick="document.getElementById('mainImage').src=this.src"
                 class="img-thumbnail" style="width: 100px; cursor: pointer;">
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="col-md-6">
      <div class="border p-4 rounded shadow-sm">
        <h2>{{ product['name'] }}</h2>
        <p class="text-muted">{{ product['description'] }}</p>

        {% if product['sale_price'] and product['sale_price'] < product['price'] %}
          <p>
            <span class="text-muted text-decoration-line-through">{{ product['price']|currency }} VND</span><br>
            <span class="text-danger fw-bold fs-4">{{ product['sale_price']|currency }} VND</span>
          </p>
        {% else %}
          <h4 class="text-danger">{{ product['price']|currency }} VND</h4>
        {% endif %}

        <!-- Ch·ªâ c√≤n n√∫t ƒê·∫∑t h√†ng -->
        <form method="POST" action="{{ url_for('add_to_cart', product_id=product['id']) }}">
          <div class="mb-3">
            <label class="form-label">S·ªë l∆∞·ª£ng</label>
            <input type="number" name="quantity" value="1" min="1" class="form-control w-50">
          </div>
          <input type="hidden" name="redirect" value="checkout">
          <button type="submit" class="btn btn-success">‚ö° ƒê·∫∑t h√†ng</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS Animation -->
<script>
  const mainImage = document.getElementById("mainImage");
  const cartIcon = document.getElementById("cart-icon");

  document.getElementById("addBtn").addEventListener("click", function () {
    const qty = document.getElementById("quantity").value;
    const url = "{{ url_for('add_to_cart', product_id=product['id']) }}";

    // Animation clone
    const imgClone = mainImage.cloneNode(true);
    const rect = mainImage.getBoundingClientRect();
    imgClone.style.position = "fixed";
    imgClone.style.left = rect.left + "px";
    imgClone.style.top = rect.top + "px";
    imgClone.style.width = mainImage.offsetWidth + "px";
    imgClone.style.height = mainImage.offsetHeight + "px";
    imgClone.style.transition = "all 0.8s ease-in-out";
    imgClone.style.zIndex = 1000;
    document.body.appendChild(imgClone);

    const cartRect = cartIcon.getBoundingClientRect();

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: "quantity=" + encodeURIComponent(qty)
    }).then(res => {
      if (res.ok) {
        imgClone.style.left = cartRect.left + "px";
        imgClone.style.top = cartRect.top + "px";
        imgClone.style.opacity = 0.5;
        imgClone.style.transform = "scale(0.2)";
        setTimeout(() => {
          imgClone.remove();
          document.getElementById("addedAlert").classList.remove("d-none");
          setTimeout(() => {
            document.getElementById("addedAlert").classList.add("d-none");
          }, 2000);
        }, 800);
      }
    });
  });

  // Sync quantity
  document.getElementById("quantity").addEventListener("input", function () {
    document.getElementById("quickQty").value = this.value;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
